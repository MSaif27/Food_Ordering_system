{% extends 'orders/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Cart | LPU Food System{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h2 class="fw-bold mb-0"><i class="bi bi-cart3 me-2"></i>Your Cart</h2>
  </div>
</div>

<div class="container pb-5">
  {% if cart_items %}
  <div class="row g-4">

    <!-- Cart Items -->
    <div class="col-md-8">
      <div class="card p-3">
        <h5 class="fw-bold mb-4">Order Items</h5>
        <table class="table">
          <thead class="table-light">
            <tr>
              <th>Item</th>
              <th>Stall</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for ci in cart_items %}
            <tr>
              <td class="fw-semibold">{{ ci.food_item.name }}</td>
              <td class="text-muted">{{ ci.food_item.stall.name }}</td>
              <td>â‚¹{{ ci.food_item.price }}</td>
              <td>{{ ci.quantity }}</td>
              <td class="fw-bold text-success">â‚¹{{ ci.subtotal }}</td>
              <td>
                <a href="{% url 'remove_from_cart' ci.food_item.id %}" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <td colspan="4" class="fw-bold text-end">Total:</td>
              <td colspan="2" class="fw-bold text-success fs-5">â‚¹{{ total }}</td>
            </tr>
          </tfoot>
        </table>

        <a href="{% url 'menu' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>Continue Shopping
        </a>
      </div>
    </div>

    <!-- Order Placement -->
    <div class="col-md-4">
      <div class="card p-4">
        <h5 class="fw-bold mb-4">Place Your Order</h5>
        <form action="{% url 'place_order' %}" method="post">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label fw-semibold">Select Break Time Slot *</label>
            <select name="time_slot" class="form-select" required>
              <option value="">-- Choose a slot --</option>
              {% for slot in time_slots %}
              <option value="{{ slot.id }}" {% if not slot.is_available %}disabled{% endif %}>
                {{ slot.get_slot_time_display }}
                {% if not slot.is_available %} (Full){% endif %}
              </option>
              {% endfor %}
            </select>
            <div class="form-text">Only one slot per day. Choose wisely!</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Special Instructions</label>
            <textarea name="special_instructions" class="form-control" rows="3"
              placeholder="Allergies, customizations..."></textarea>
          </div>

          <div class="card bg-light p-3 mb-3">
            <div class="d-flex justify-content-between">
              <span>Items:</span>
              <span>{{ cart_items|length }}</span>
            </div>
            <div class="d-flex justify-content-between fw-bold text-success">
              <span>Total Amount:</span>
              <span>â‚¹{{ total }}</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-2">
            <i class="bi bi-check-circle me-2"></i>Confirm Order
          </button>
        </form>
      </div>
    </div>
  </div>

  {% else %}
  <div class="text-center py-5">
    <div style="font-size:5rem;">ðŸ›’</div>
    <h4 class="mt-3">Your cart is empty</h4>
    <p class="text-muted">Browse the menu and add some delicious items!</p>
    <a href="{% url 'menu' %}" class="btn btn-primary btn-lg mt-2">
      <i class="bi bi-grid me-2"></i>Browse Menu
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}
